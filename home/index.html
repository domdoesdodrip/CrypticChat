<!-- FULL FILE â€“ NO TRUNCATION -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CrypticChat</title>

<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root { --bg:#050307; --accent:#9667f4 }
body { margin:0; background:var(--bg); color:white; font-family:Manrope; height:100dvh; overflow:hidden }

.glass { background:rgba(15,12,22,.85); backdrop-filter:blur(20px); border:1px solid rgba(150,103,244,.15) }
.bubble { max-width:85%; padding:10px 16px; border-radius:18px; margin-bottom:6px }
.mine { background:var(--accent); align-self:flex-end }
.theirs { background:#1f1d2b }

.status-vc { color:#22c55e }
.vc-badge { font-size:9px; margin-left:6px; color:#22c55e; font-weight:800 }

.admin-panel {
  position:fixed; inset:0; background:rgba(0,0,0,.7);
  display:none; align-items:center; justify-content:center; z-index:9999
}
.admin-panel.active { display:flex }
.disco {
  position:fixed; inset:0; pointer-events:none;
  animation:rainbow 1s linear infinite; z-index:9998
}
@keyframes rainbow {
  0%{background:red}20%{background:orange}40%{background:yellow}
  60%{background:green}80%{background:blue}100%{background:purple}
}
</style>
</head>

<body>

<div id="adminPanel" class="admin-panel">
  <div class="glass p-6 rounded-xl space-y-3 w-80 text-center">
    <h2 class="font-black uppercase">admin panel</h2>
    <button onclick="purge()" class="w-full bg-red-600 p-2 rounded">purge chat</button>
    <button onclick="announce()" class="w-full bg-purple-600 p-2 rounded">announce</button>
    <button onclick="disco()" class="w-full bg-pink-600 p-2 rounded">disco</button>
    <button onclick="toggleAdmin(false)" class="w-full bg-white/10 p-2 rounded">close</button>
  </div>
</div>

<div id="discoOverlay"></div>

<div id="app-root" class="h-full flex flex-col">

<!-- AUTH -->
<div id="view-auth" class="flex-1 flex items-center justify-center">
  <div class="glass p-8 rounded-3xl w-96 text-center">
    <h1 class="font-black text-3xl mb-6">crypticchat</h1>
    <input id="auth-user" class="w-full p-3 mb-3 bg-white/5 rounded" placeholder="username">
    <input id="auth-pass" type="password" class="w-full p-3 mb-4 bg-white/5 rounded" placeholder="password">
    <button id="loginBtn" class="w-full bg-purple-600 p-3 rounded font-black">sign in</button>
    <button id="signupBtn" class="mt-3 text-xs opacity-50">sign up instead</button>
  </div>
</div>

<!-- JOIN -->
<div id="view-join" class="hidden flex-1 flex items-center justify-center">
  <div class="glass p-8 rounded-3xl w-96 text-center">
    <input id="display-name" class="w-full p-3 mb-3 bg-white/5 rounded" placeholder="alias">
    <input id="room-id" class="w-full p-3 mb-4 bg-white/5 rounded" placeholder="room">
    <button id="join-room-btn" class="w-full bg-purple-600 p-3 rounded font-black">join</button>
  </div>
</div>

<!-- CHAT -->
<div id="view-chat" class="hidden flex-1 flex">
  <aside class="w-64 glass p-3 overflow-y-auto">
    <div id="users-list" class="space-y-2"></div>
    <button id="adminBtn" onclick="toggleAdmin(true)" class="hidden mt-4 w-full bg-red-600 p-2 rounded text-xs">admin</button>
  </aside>

  <main class="flex-1 flex flex-col">
    <div id="messages" class="flex-1 p-4 overflow-y-auto"></div>
    <div class="p-3 flex gap-2">
      <div id="input" contenteditable class="flex-1 bg-white/5 p-3 rounded"></div>
      <button id="send-btn" class="bg-purple-600 p-3 rounded">send</button>
    </div>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"

const app = initializeApp({ /* same config */ })
const db = getFirestore(app)

let isAdmin = false, myName, room, ably, channel

// LOGIN / SIGNUP
loginBtn.onclick = async () => {
  const u = auth-user.value.toLowerCase(), p = auth-pass.value
  const ref = doc(db,"users",u)
  const snap = await getDoc(ref)
  if(!snap.exists()) return alert("no account")
  if(snap.data().password!==p) return alert("wrong pass")
  isAdmin = snap.data().isAdmin === true
  persist(u,p)
  showJoin()
}

signupBtn.onclick = async () => {
  const u = auth-user.value.toLowerCase(), p = auth-pass.value
  await setDoc(doc(db,"users",u),{password:p,isAdmin:false})
  alert("account created")
}

function persist(u,p){
  localStorage.setItem("cc_user",u)
  localStorage.setItem("cc_pass",p)
}

function showJoin(){
  view-auth.classList.add("hidden")
  view-join.classList.remove("hidden")
}

// JOIN ROOM
join-room-btn.onclick = () => {
  myName = display-name.value || "phantom"
  room = room-id.value || "global"
  localStorage.setItem("cc_room",room)
  enter()
}

function enter(){
  view-join.classList.add("hidden")
  view-chat.classList.remove("hidden")
  if(isAdmin) adminBtn.classList.remove("hidden")

  ably = new Ably.Realtime("YOUR_ABLY_KEY")
  channel = ably.channels.get(room)

  channel.presence.enter({ user:myName, inCall:false })
  channel.presence.subscribe(updateUsers)

  channel.subscribe("kick",m=>{
    if(m.data===myName) location.reload()
  })

  onSnapshot(collection(db,"rooms",room,"messages"),snap=>{
    messages.innerHTML=""
    snap.forEach(d=>renderMsg(d.data()))
  })
}

// USERS LIST FIX
function updateUsers(){
  channel.presence.get((_,m)=>{
    users-list.innerHTML = m.map(u=>`
      <div class="bg-white/5 p-2 rounded">
        <span class="${u.data.inCall?'status-vc':''}">
          ${u.data.user}
        </span>
        ${u.data.inCall?'<span class="vc-badge">IN VC</span>':''}
        ${isAdmin && u.data.user!==myName?`<button onclick="kick('${u.data.user}')" class="ml-2 text-red-500">kick</button>`:''}
      </div>
    `).join("")
  })
}

function kick(u){
  channel.publish("kick",u)
}

// ADMIN
function toggleAdmin(v){ adminPanel.classList.toggle("active",v) }

async function purge(){
  const q = await getDocs(collection(db,"rooms",room,"messages"))
  q.forEach(d=>deleteDoc(d.ref))
}

function announce(){
  const t = prompt("announcement")
  channel.publish("announce",t)
}

function disco(){
  const d = document.createElement("div")
  d.className="disco"
  document.body.appendChild(d)
  setTimeout(()=>d.remove(),15000)
}

// MESSAGES
send-btn.onclick = ()=> {
  if(!input.innerText.trim()) return
  addDoc(collection(db,"rooms",room,"messages"),{user:myName,text:input.innerText})
  input.innerText=""
}

function renderMsg(m){
  const d=document.createElement("div")
  d.className="bubble "+(m.user===myName?"mine":"theirs")
  d.innerText=`${m.user}: ${m.text}`
  messages.appendChild(d)
}
</script>
</body>
</html>
