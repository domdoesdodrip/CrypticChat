<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>CrypticChat</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050307; --accent: #9667f4; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Manrope', sans-serif; height: 100dvh; overflow: hidden; }
        .glass { background: rgba(15, 12, 22, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(150, 103, 244, 0.15); }
        .bubble { max-width: 85%; padding: 10px 16px; border-radius: 18px; margin-bottom: 6px; position: relative; }
        .mine { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 4px; }
        .theirs { background: #1f1d2b; align-self: flex-start; border-bottom-left-radius: 4px; }
        #input { background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); outline: none; padding: 12px; border-radius: 12px; width: 100%; min-height: 48px; font-size: 15px; }
        .vc-active { background: #10b981 !important; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
    </style>
</head>
<body>

<canvas id="snow-canvas" style="position:fixed; inset:0; z-index:-1; pointer-events:none;"></canvas>

<div id="app-root" class="h-full w-full flex flex-col">
    <div id="view-login" class="flex-1 flex items-center justify-center p-4">
        <div class="glass w-full max-w-md p-8 rounded-3xl text-center">
            <h1 class="text-4xl font-black mb-8 tracking-tighter text-purple-400">CRYPTIC</h1>
            <input id="name" type="text" class="w-full mb-3 p-4 bg-white/5 rounded-xl text-center outline-none border border-white/5" placeholder="Username">
            <input id="room" type="text" class="w-full mb-6 p-4 bg-white/5 rounded-xl text-center outline-none border border-white/5" placeholder="Room ID">
            <button id="join-btn" class="w-full bg-purple-600 py-4 rounded-xl font-extrabold">CONNECT</button>
        </div>
    </div>

    <div id="view-chat" class="hidden h-full flex flex-col">
        <header class="glass h-16 flex items-center justify-between px-4">
            <div id="roomLabel" class="font-black text-purple-500 uppercase"></div>
            <button onclick="location.reload()" class="text-xs font-bold opacity-50">LEAVE</button>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside class="hidden lg:flex flex-col w-64 glass p-4 border-r border-white/5">
                <div class="mb-6">
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest block mb-4">Voice Channel</span>
                    <button id="vc-btn" class="w-full py-2 rounded-lg bg-white/5 text-[10px] font-black border border-white/10 transition-all">JOIN VOICE</button>
                    <div id="vc-list" class="mt-3 space-y-1"></div>
                </div>
                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest block mb-4">Other Rooms</span>
                <div id="room-list" class="space-y-1 overflow-y-auto text-xs"></div>
            </aside>

            <main class="flex-1 flex flex-col relative">
                <div id="messages" class="flex-1 p-4 pb-24 flex flex-col overflow-y-auto space-y-1"></div>
                <div class="absolute bottom-0 left-0 right-0 p-3 bg-black/80 backdrop-blur-md border-t border-white/10">
                    <div class="flex gap-2 max-w-4xl mx-auto">
                        <div id="input" contenteditable="true" placeholder="Type a message..."></div>
                        <button id="send-btn" class="bg-purple-600 p-3 rounded-xl font-bold">SEND</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, collection, addDoc, setDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBQgVAxkkRao1PzzR6IAwjUSSf7YComLyY", authDomain: "crypticchat-2265e.firebaseapp.com", projectId: "crypticchat-2265e", storageBucket: "crypticchat-2265e.firebasestorage.app", messagingSenderId: "684175124793", appId: "1:684175124793:web:4163bf1f53e4da9fad20e8" };
const db = getFirestore(initializeApp(firebaseConfig));

let ably, channel, myName, myId, inVC = false;
myId = localStorage.getItem('cryptic_uid') || 'uid-' + Math.random().toString(36).substring(2, 12);
localStorage.setItem('cryptic_uid', myId);

// 1. Room Discovery: Monitor ALL active rooms
onSnapshot(collection(db, "active_rooms"), (snap) => {
    const list = document.getElementById("room-list");
    list.innerHTML = "";
    snap.forEach(d => {
        const btn = document.createElement("div");
        btn.className = "p-2 bg-white/5 rounded border border-white/5 cursor-pointer hover:bg-white/10";
        btn.innerText = `# ${d.id}`;
        btn.onclick = () => { document.getElementById("room").value = d.id; location.reload(); };
        list.appendChild(btn);
    });
});

document.getElementById("join-btn").onclick = async () => {
    myName = document.getElementById("name").value.trim();
    const roomID = (document.getElementById("room").value.trim() || "GLOBAL").toUpperCase();
    if(!myName) return;

    // Register room in DB so others see it
    await setDoc(doc(db, "active_rooms", roomID), { lastUpdate: serverTimestamp() });

    ably = new Ably.Realtime({ key: "wAzn4w.mKjo7A:25mq_B3LXbGCHbhVavWUtbdzVySNIPg2ZOtO22bEqU8", clientId: myId });
    channel = ably.channels.get("room-" + roomID);

    channel.presence.enter({ user: myName, inVC: false }, () => {
        document.getElementById("view-login").classList.add("hidden"); 
        document.getElementById("view-chat").classList.remove("hidden");
        document.getElementById("roomLabel").innerText = roomID;

        // Load Messages
        onSnapshot(query(collection(db, "rooms", roomID, "messages"), orderBy("timestamp", "asc")), (s) => {
            s.docChanges().forEach(c => { if(c.type === "added") render(c.doc.data()); });
        });

        channel.presence.subscribe(() => syncVC());
        syncVC();
    });
};

function render(d) {
    const box = document.getElementById("messages");
    const div = document.createElement("div");
    const me = d.uid === myId;
    div.className = `bubble flex flex-col ${me?'mine':'theirs'}`;
    div.innerHTML = `<div class="text-[10px] opacity-50 mb-1">${d.user}</div><span class="text-sm">${d.text}</span>`;
    box.appendChild(div); box.scrollTop = box.scrollHeight;
}

document.getElementById("send-btn").onclick = async () => {
    const input = document.getElementById("input"), rID = document.getElementById("roomLabel").innerText;
    if(!input.innerText.trim()) return;
    await addDoc(collection(db, "rooms", rID, "messages"), { user: myName, uid: myId, text: input.innerText, timestamp: serverTimestamp() });
    input.innerText = "";
};

// 2. VC Implementation Placeholder
// To actually hear others, we'd need to set up a PeerConnection for every user in presence.
// For now, this updates the presence state so you can see who is "in" the voice channel.
function syncVC() {
    channel.presence.get((err, members) => {
        const list = document.getElementById("vc-list");
        list.innerHTML = members.filter(m => m.data.inVC).map(m => `
            <div class="flex items-center gap-2 text-xs font-bold text-green-400">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> ${m.data.user}
            </div>
        `).join("");
    });
}

document.getElementById("vc-btn").onclick = function() {
    inVC = !inVC;
    this.innerText = inVC ? "LEAVE VOICE" : "JOIN VOICE";
    this.className = inVC ? "w-full py-2 rounded-lg vc-active text-[10px] font-black transition-all" : "w-full py-2 rounded-lg bg-white/5 text-[10px] font-black border border-white/10 transition-all";
    channel.presence.update({ user: myName, inVC });
};

// Simple Snow
const canvas = document.getElementById("snow-canvas"), ctx = canvas.getContext("2d");
let snow = [];
function res() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; snow = Array.from({length: 30}, () => ({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*2+1, s:Math.random()*0.5+0.2})); }
window.onresize = res; res();
function draw() { ctx.clearRect(0,0,canvas.width,canvas.height); snow.forEach(p => { p.y += p.s; if(p.y > canvas.height) p.y = -5; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fillStyle="white"; ctx.fill(); }); requestAnimationFrame(draw); }
draw();
</script>
</body>
</html>
