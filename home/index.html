<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>CrypticChat</title>

  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root { --bg:#050307; --accent:#9667f4 }
    body { margin:0; background:var(--bg); color:white; font-family:Manrope,sans-serif; height:100dvh; width:100vw; overflow:hidden }
    #snow-canvas { position:fixed; inset:0; z-index:-1; pointer-events:none }
    .glass { background:rgba(15,12,22,.9); backdrop-filter:blur(20px); border:1px solid rgba(150,103,244,.15) }
    @keyframes msgIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .animate-msg { animation:msgIn .25s ease-out forwards }
    .bubble { max-width:85%; padding:10px 16px; border-radius:18px; margin-bottom:6px }
    .mine { background:var(--accent); align-self:flex-end; border-bottom-right-radius:4px }
    .theirs { background:#1f1d2b; align-self:flex-start; border-bottom-left-radius:4px }
    #input { background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:12px; min-height:48px; max-height:120px; overflow-y:auto }
    #input:empty:before { content:attr(placeholder); color:#6b7280 }
  </style>
</head>

<body>
<canvas id="snow-canvas"></canvas>

<div id="view-auth" class="flex h-full items-center justify-center p-4">
  <div class="glass w-full max-w-md p-10 rounded-[2.5rem] text-center">
    <h1 id="auth-title" class="text-4xl font-black mb-10 uppercase">Login</h1>
    <input id="auth-user" class="w-full mb-4 p-4 bg-white/5 rounded-2xl outline-none" placeholder="Username">
    <input id="auth-pass" type="password" class="w-full mb-8 p-4 bg-white/5 rounded-2xl outline-none" placeholder="Password">
    <button id="auth-main-btn" class="w-full bg-purple-600 py-5 rounded-2xl font-extrabold uppercase text-xs">Enter</button>
  </div>
</div>

<div id="view-join" class="hidden flex h-full items-center justify-center p-4">
  <div class="glass w-full max-w-md p-10 rounded-[2.5rem] text-center">
    <h1 class="text-3xl font-black mb-6 uppercase">Verified</h1>
    <input id="display-name" class="w-full mb-4 p-4 bg-white/5 rounded-2xl outline-none" placeholder="Alias (optional)">
    <input id="room-id" class="w-full mb-8 p-4 bg-white/5 rounded-2xl outline-none" placeholder="Room ID">
    <button id="join-room-btn" class="w-full bg-purple-600 py-5 rounded-2xl font-extrabold uppercase text-xs">Enter</button>
  </div>
</div>

<div id="view-chat" class="hidden h-full flex flex-col">

  <!-- topbar -->
  <header class="glass h-14 fixed top-0 left-0 right-0 z-40 flex items-center justify-between px-4">
    <div class="text-xs font-black uppercase text-purple-400">
      room <span id="roomLabel"></span>
    </div>
    <button id="exit-btn" class="bg-red-500/10 text-red-500 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase">
      exit
    </button>
  </header>

  <div id="messages" class="flex-1 pt-20 pb-24 p-4 flex flex-col overflow-y-auto"></div>

  <div class="fixed bottom-0 left-0 right-0 p-3 bg-black/80 backdrop-blur-md border-t border-white/10">
    <div class="flex gap-2 max-w-4xl mx-auto">
      <div id="input" contenteditable placeholder="Message..."></div>
      <button id="send-btn" class="bg-purple-600 p-3 rounded-xl font-bold">âž¤</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyBQgVAxkkRao1PzzR6IAwjUSSf7YComLyY",
  authDomain:"crypticchat-2265e.firebaseapp.com",
  projectId:"crypticchat-2265e",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let ably, channel, myAccountName, myDisplayName, isAdmin = false;

const ADMINS = ["youradminusername"];

document.getElementById("auth-main-btn").onclick = async () => {
  const user = auth-user.value.trim().toLowerCase();
  const pass = auth-pass.value.trim();
  if(!user || !pass) return;

  const ref = doc(db,"users",user);
  const snap = await getDoc(ref);
  if(!snap.exists() || snap.data().password !== pass) return;

  localStorage.setItem("login",JSON.stringify({user,pass}));
  myAccountName = user;
  isAdmin = ADMINS.includes(user);
  initAbly(user,pass);
};

function initAbly(user,pass){
  ably = new Ably.Realtime({ authUrl:"/api/ably-token", authParams:{ username:user,password:pass } });
  ably.connection.once("connected",()=>{
    view-auth.classList.add("hidden");
    view-join.classList.remove("hidden");
  });
}

join-room-btn.onclick = ()=>{
  myDisplayName = display-name.value.trim() || myAccountName;
  const room = (room-id.value || "GLOBAL").toUpperCase();
  localStorage.setItem("currentRoom",room);

  view-join.classList.add("hidden");
  view-chat.classList.remove("hidden");
  roomLabel.innerText = room;

  channel = ably.channels.get("room-"+room,{ params:{ rewind:"100" }});

  channel.history({limit:100},(_,page)=>{
    page?.items.reverse().forEach(m=>{
      if(m.name==="msg"){
        render(m.data.user,m.data.text,m.clientId===ably.auth.clientId,m.data.msgId);
      }
    });
  });

  channel.subscribe("msg",m=>{
    if(m.clientId!==ably.auth.clientId){
      render(m.data.user,m.data.text,false,m.data.msgId);
    }
  });
};

function render(user,text,me,id){
  const d=document.createElement("div");
  d.id=id;
  d.className=`bubble animate-msg ${me?"mine":"theirs"}`;
  d.innerHTML=`${!me?`<div class="text-[9px] text-purple-400 font-bold mb-1">${user}</div>`:""}<div>${text}</div>`;
  messages.appendChild(d);
  messages.scrollTop=messages.scrollHeight;
}

send-btn.onclick=()=>{
  const text=input.innerText.trim();
  if(!text) return;
  const id="m-"+Math.random().toString(36).slice(2,9);
  channel.publish("msg",{ user:myDisplayName,text,msgId:id });
  render(myDisplayName,text,true,id);
  input.innerHTML="";
};

exit-btn.onclick=()=>{
  localStorage.removeItem("currentRoom");
  location.reload();
};

window.addEventListener("load",()=>{
  const saved=localStorage.getItem("login");
  if(saved){
    const {user,pass}=JSON.parse(saved);
    auth-user.value=user;
    auth-pass.value=pass;
    myAccountName=user;
    isAdmin=ADMINS.includes(user);
    initAbly(user,pass);
  }

  const room=localStorage.getItem("currentRoom");
  if(room) room-id.value=room;
});
</script>

<script>
const c=document.getElementById("snow-canvas"),x=c.getContext("2d");
let s=[];
function r(){c.width=innerWidth;c.height=innerHeight;s=Array.from({length:45},()=>({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*2+1,d:Math.random()*.5+.3}))}
onresize=r;r();
(function f(){x.clearRect(0,0,c.width,c.height);s.forEach(p=>{p.y+=p.d;if(p.y>c.height)p.y=-10;x.beginPath();x.arc(p.x,p.y,p.r,0,Math.PI*2);x.fillStyle="rgba(255,255,255,.2)";x.fill()});requestAnimationFrame(f)})();
</script>
</body>
</html>
